#include "reporting.h"
#include "arch_registry.h"
#include "testing_core.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// ========================================
// PROGRESS BAR AND FORMATTING FUNCTIONS
// ========================================

void print_progress_bar(double percent, int width, bool compact) {
    if (compact) {
        // Ultra-compact: just percentage
        printf("%5.1f%%", percent);
        return;
    }
    
    if (width < 5) width = 5;
    if (width > 20) width = 20;
    
    int bars = (int)(percent * width / 100.0);
    printf("[");
    for (int i = 0; i < width; i++) {
        if (i < bars) printf("#");
        else printf(".");
    }
    printf("]");
}

// ========================================
// COMPACT REPORTING FUNCTIONS
// ========================================

void print_instruction_completeness_report_compact(arch_test_result_t *results, size_t arch_count, const report_config_t *config) {
    int max_width = config ? config->max_line_width : 80;
    bool compact = config ? config->compact_mode : false;
    bool show_bars = config ? config->show_progress_bars : true;
    
    printf("\n");
    if (compact) {
        // Ultra-compact format
        printf("+============================================================================+\n");
        printf("|                    STAS INSTRUCTION SET COMPLETENESS                      |\n");
        printf("+============================================================================+\n");
        
        for (size_t i = 0; i < arch_count; i++) {
            arch_test_result_t *arch = &results[i];
            printf("| %-8s | Overall: ", arch->arch_name);
            print_progress_bar(arch->overall.recognition_percent, 0, true);
            printf(" rec, ");
            print_progress_bar(arch->overall.functional_percent, 0, true);
            printf(" func");
            
            // Pad to line width
            int used = 25 + 12; // approx used chars
            for (int j = used; j < max_width - 3; j++) printf(" ");
            printf("|\n");
            
            // Show top categories briefly
            for (size_t j = 0; j < arch->category_count && j < 3; j++) {
                category_result_t *cat = &arch->category_results[j];
                printf("|   %-12s | ", cat->category_name);
                print_progress_bar(cat->result.recognition_percent, 0, true);
                printf("/");
                print_progress_bar(cat->result.functional_percent, 0, true);
                
                int used = 20 + 12; // approx used chars  
                for (int k = used; k < max_width - 3; k++) printf(" ");
                printf("|\n");
            }
            
            if (i < arch_count - 1) {
                printf("+----------------------------------------------------------------------------+\n");
            }
        }
        printf("+============================================================================+\n");
    } else {
        // Standard width format - proper rectangular table (67 chars each line)
        printf("+----------+------------------+---------+------------+------------+\n");
        printf("| ARCH     | CATEGORY         | COUNT   | RECOG      | FUNC       |\n");
        printf("+----------+------------------+---------+------------+------------+\n");
        
        for (size_t i = 0; i < arch_count; i++) {
            arch_test_result_t *arch = &results[i];
            
            for (size_t j = 0; j < arch->category_count; j++) {
                category_result_t *cat = &arch->category_results[j];
                
                // Format the count as a 7-character string
                char count_str[8];
                snprintf(count_str, sizeof(count_str), "%zu/%zu", 
                         cat->result.recognized, cat->result.total);
                
                printf("| %-8s | %-16s | %-7s | ", 
                       (j == 0) ? arch->arch_name : "", // arch name only on first row
                       cat->category_name, 
                       count_str);
                
                // Recognition column - exactly 10 characters
                if (show_bars) {
                    print_progress_bar(cat->result.recognition_percent, 8, false);
                } else {
                    printf("%8.1f%%", cat->result.recognition_percent);
                }
                printf(" | ");
                
                // Functional column - exactly 10 characters  
                if (show_bars) {
                    print_progress_bar(cat->result.functional_percent, 8, false);
                } else {
                    printf("%8.1f%%", cat->result.functional_percent);
                }
                printf(" |\n");
            }
            
            printf("+----------+------------------+---------+------------+------------+\n");
            
            // Format OVERALL count as a 7-character string
            char overall_count_str[8];
            snprintf(overall_count_str, sizeof(overall_count_str), "%zu/%zu", 
                     arch->overall.recognized, arch->overall.total);
            
            printf("| %-8s | %-16s | %-7s | ", 
                   "", // empty 
                   "OVERALL",
                   overall_count_str);
            
            // Recognition column for OVERALL
            if (show_bars) {
                print_progress_bar(arch->overall.recognition_percent, 8, false);
            } else {
                printf("%8.1f%%", arch->overall.recognition_percent);
            }
            printf(" | ");
            
            // Functional column for OVERALL
            if (show_bars) {
                print_progress_bar(arch->overall.functional_percent, 8, false);
            } else {
                printf("%8.1f%%", arch->overall.functional_percent);
            }
            printf(" |\n");
            
            if (i < arch_count - 1) {
                printf("+----------+------------------+---------+------------+------------+\n");
            }
        }
        printf("+----------+------------------+---------+------------+------------+\n");
    }
    
    printf("\n    Legend: ");
    if (show_bars && !compact) {
        printf("# = ~12.5%% per char, . = remaining\n");
    } else {
        printf("Recognition%% / Functional%%\n");
    }
    printf("    Recognition: Instruction parsing successful\n");
    printf("    Functional: Instruction encoding successful\n\n");
}

// ========================================
// FULL REPORTING FUNCTIONS
// ========================================

void print_instruction_completeness_report(arch_test_result_t *results, size_t arch_count) {
    printf("\n");
    printf("+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+\n");
    printf("|                                                                   STAS INSTRUCTION SET COMPLETENESS REPORT                                                                                  |\n");
    printf("+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+\n");
    
    for (size_t i = 0; i < arch_count; i++) {
        arch_test_result_t *arch = &results[i];
        
        printf("| %-12s | Category Breakdown                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |\n", arch->arch_name);
        printf("+--------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n");
        
        for (size_t j = 0; j < arch->category_count; j++) {
            category_result_t *cat = &arch->category_results[j];
            printf("|              | %-18s | Total: %3zu | Recognized: %3zu (%5.1f%%) | Functional: %3zu (%5.1f%%) | Recognition: ", 
                   cat->category_name, 
                   cat->result.total,
                   cat->result.recognized, 
                   cat->result.recognition_percent,
                   cat->result.functional, 
                   cat->result.functional_percent);
            
            // Recognition progress bar
            int rec_bars = (int)(cat->result.recognition_percent / 5);
            printf("[");
            for (int k = 0; k < 20; k++) {
                if (k < rec_bars) printf("#");
                else printf(".");
            }
            printf("] Functional: [");
            
            // Functional progress bar
            int func_bars = (int)(cat->result.functional_percent / 5);
            for (int k = 0; k < 20; k++) {
                if (k < func_bars) printf("#");
                else printf(".");
            }
            printf("]\t|\n");
        }
        
        printf("+--------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+\n");
        printf("| OVERALL      | %-18s | Total: %3zu | Recognized: %3zu (%5.1f%%) | Functional: %3zu (%5.1f%%) | Recognition: ", 
               "Summary",
               arch->overall.total,
               arch->overall.recognized, 
               arch->overall.recognition_percent,
               arch->overall.functional, 
               arch->overall.functional_percent);
        
        // Overall recognition progress bar
        int overall_rec_bars = (int)(arch->overall.recognition_percent / 5);
        printf("[");
        for (int k = 0; k < 20; k++) {
            if (k < overall_rec_bars) printf("#");
            else printf(".");
        }
        printf("] Functional: [");
        
        // Overall functional progress bar
        int overall_func_bars = (int)(arch->overall.functional_percent / 5);
        for (int k = 0; k < 20; k++) {
            if (k < overall_func_bars) printf("#");
            else printf(".");
        }
        printf("]\t|\n");
        
        if (i < arch_count - 1) {
            printf("+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+\n");
        }
    }
    
    printf("+==============================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================================+\n");
    
    printf("\n    Legend: # = 5%% completion per char, . = remaining\n");
    printf("    Recognition: Instruction parsing successful\n");
    printf("    Functional: Instruction encoding successful\n\n");
}

void print_instruction_completeness_report_with_config(arch_test_result_t *results, size_t arch_count, const report_config_t *config) {
    if (config && (config->compact_mode || config->max_line_width <= 80)) {
        print_instruction_completeness_report_compact(results, arch_count, config);
    } else {
        print_instruction_completeness_report(results, arch_count);
    }
}

// ========================================
// MAIN TEST RUNNER FUNCTIONS
// ========================================

void run_instruction_completeness_tests_with_config(const report_config_t *config) {
    printf("🚀 Starting STAS Instruction Set Completeness Analysis...\n");
    
    // Get all architectures
    size_t architecture_count;
    const arch_instruction_set_t** architectures = get_all_architectures(&architecture_count);
    
    // Determine which architectures to test
    size_t test_arch_count = 0;
    size_t start_idx = 0;
    size_t end_idx = architecture_count;
    
    if (config && config->target_arch) {
        // Find the specific architecture
        for (size_t i = 0; i < architecture_count; i++) {
            if (strcmp(architectures[i]->arch_name, config->target_arch) == 0) {
                start_idx = i;
                end_idx = i + 1;
                test_arch_count = 1;
                break;
            }
        }
        if (test_arch_count == 0) {
            printf("❌ Error: Architecture '%s' not found!\n", config->target_arch);
            return;
        }
        printf("🎯 Testing only %s architecture...\n", config->target_arch);
    } else {
        test_arch_count = architecture_count;
        printf("📊 Testing all %zu architectures...\n", architecture_count);
    }
    
    arch_test_result_t *results = malloc(test_arch_count * sizeof(arch_test_result_t));
    
    for (size_t i = start_idx, result_idx = 0; i < end_idx; i++, result_idx++) {
        const arch_instruction_set_t *arch = architectures[i];
        arch_test_result_t *result = &results[result_idx];
        
        result->arch_name = arch->arch_name;
        result->category_count = arch->category_count;
        result->category_results = malloc(arch->category_count * sizeof(category_result_t));
        
        // Initialize overall counters
        result->overall.total = 0;
        result->overall.recognized = 0;
        result->overall.functional = 0;
        
        printf("📋 Testing %s instruction set...\n", arch->arch_name);
        
        for (size_t j = 0; j < arch->category_count; j++) {
            const instruction_category_t *category = &arch->categories[j];
            category_result_t *cat_result = &result->category_results[j];
            
            cat_result->category_name = category->category_name;
            cat_result->result = test_instruction_category_verbose(arch->arch_name, category, 
                                                                 config ? config->verbose_mode : false);
            
            // Add to overall totals
            result->overall.total += cat_result->result.total;
            result->overall.recognized += cat_result->result.recognized;
            result->overall.functional += cat_result->result.functional;
            
            printf("   ✓ %s: %zu/%zu recognized (%.1f%%), %zu/%zu functional (%.1f%%)\n",
                   category->category_name,
                   cat_result->result.recognized, cat_result->result.total, cat_result->result.recognition_percent,
                   cat_result->result.functional, cat_result->result.total, cat_result->result.functional_percent);
        }
        
        // Calculate overall percentages
        result->overall.recognition_percent = result->overall.total > 0 ? 
            (double)result->overall.recognized / result->overall.total * 100.0 : 0.0;
        result->overall.functional_percent = result->overall.total > 0 ? 
            (double)result->overall.functional / result->overall.total * 100.0 : 0.0;
    }
    
    print_instruction_completeness_report_with_config(results, test_arch_count, config);
    
    // Cleanup
    for (size_t i = 0; i < test_arch_count; i++) {
        free(results[i].category_results);
    }
    free(results);
    
    printf("✅ Instruction set completeness analysis completed!\n");
}

void run_instruction_completeness_tests(void) {
    // Use compact format by default
    report_config_t config = {
        .max_line_width = 80,
        .compact_mode = false,  // Standard format within 80 chars
        .show_progress_bars = true,
        .verbose_mode = false,
        .target_arch = NULL
    };
    run_instruction_completeness_tests_with_config(&config);
}
